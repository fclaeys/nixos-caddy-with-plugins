#!/usr/bin/env -S nix shell -I nixpkgs=./. nixpkgs#bash nixpkgs#common-updater-scripts nixpkgs#git nixpkgs#go nixpkgs#jq nixpkgs#nix-prefetch-github -c bash

COMMIT="$1"
ROOT_DIR="$(pwd)"

git_push() {
    if [[ "$COMMIT" == "--commit" ]]; then
        (
            cd "$ROOT_DIR" || return
            git config --global user.name 'Updater'
            git config --global user.email 'robot@nowhere.invalid'
            git remote update

            alejandra .
            git add .

            git commit -m "$1"
            git push
        )
    else
        echo "$1"
    fi
}

sanitizeCfVer() {
    IFS='-' read -r -a split_version <<< "$1"
    echo "${split_version[0]}+${split_version[2]}"
}

updateInfo() {
    version=$(sed -n 's#.*github.com/caddyserver/caddy/v2 \(.*\)#\1#p' "$ROOT_DIR/src/go.mod")
    sane_version="${version:1}"

    cf_version=$(sed -n 's#.*github.com/caddy-dns/cloudflare \(.*\)#\1#p' "$ROOT_DIR/src/go.mod")
    sane_cf_version=$(sanitizeCfVer "${cf_version:1}")

    dist_hash=$(nix-prefetch-github caddyserver dist --rev "$version" | jq -r .hash)

    {
        echo '# This file was autogenerated. DO NOT EDIT!'
        echo '{'
        echo "  version = \"$sane_version\";"
        echo "  cfVersion = \"$sane_cf_version\";"
        echo "  vendorHash = \"$1\";"
        echo "  dist = {"
        echo "    owner = \"caddyserver\";"
        echo "    repo = \"dist\";"
        echo "    rev = \"$version\";"
        echo "    hash = \"$dist_hash\";"
        echo "  };"
        echo '}'
    } >"$ROOT_DIR/pkgs/info.nix"
}

updateGoSources() {
    current_version=$(nix eval --json --file "$ROOT_DIR/pkgs/info.nix" | jq -r .version)
    current_cf=$(nix eval --json --file "$ROOT_DIR/pkgs/info.nix" | jq -r .cfVersion)

    cd ./src || return
    old_hash="$(sha256sum ./go.sum)"

    rm go*
    go mod init caddy
    go mod tidy

    new_hash="$(sha256sum ./go.sum)"

    if [ "$old_hash" != "$new_hash" ]; then
        nix flake update

        updateInfo ""
        new_vendor_hash="$(nix build "$ROOT_DIR"/.# |& sed -n 's/.*got: *//p')"
        updateInfo "$new_vendor_hash"

        new_version=$(nix eval --json --file "$ROOT_DIR/pkgs/info.nix" | jq -r .version)
        new_cf=$(nix eval --json --file "$ROOT_DIR/pkgs/info.nix" | jq -r .cfVersion)

        commit_msg="ci: "

        if [[ "$current_version" != "$new_version" ]]; then
            commit_msg+="caddy $current_version -> $new_version"

        elif [[ "$current_cf" != "$new_cf" ]]; then
            commit_msg+="cloudflare-plugin $current_cf -> $new_cf"

        else
            commit_msg+="bump deps"
        fi

        git_push "$commit_msg"
    fi
}

updateGoSources
